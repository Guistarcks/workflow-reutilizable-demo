name: Test-build-sonar
on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: true
        type: string
      sonar-scanner:
        description: 'SonarQube scan mode'
        required: true
        type: string
        default: ''
      deploy-entorno:
        description: 'Default entorno for deployment'
        required: true
        type: string
        default: ''
      base-branches:
        description: 'Base branch name for PRs'
        required: true
        type: string
        default: ''
      pr-merged:
        description: 'Indicates if the PR was merged'
        required: true
        type: boolean
        default: false

jobs:

  test-unitarios:
    if: |
      always() && (
        startsWith(github.ref, 'refs/heads/feature/') ||
        startsWith(github.ref, 'refs/heads/develop') ||
        (
          inputs.pr-merged == true &&
            inputs.base-branches == 'develop' &&
            github.event_name == 'workflow_dispatch'
          )
        )
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        id: run-tests
        run: npm test -- --coverage --watchAll=false
        continue-on-error: true
        

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
       
        with:
          name: 'coverage-reports'
          path: 'coverage/'
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
      
        with:
          name: 'test-results'
          path: 'coverage/lcov.info'
          retention-days: 30

      - name: Create test summary
     
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f "coverage/lcov.info" ]; then
            echo "✅ Tests completed with coverage report" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Tests completed without coverage report" >> $GITHUB_STEP_SUMMARY
          fi

  # deploy-pre:
  #   if: github.base_ref == 'develop'
  #   needs: build
  #   uses: ./.github/workflows/action-deploy-pre.yml
  #   with:
  #     environment: 'pre-production'
  #     artifact-name: 'node-app-artifacts'
  #     deploy-path: './dist'

  # deploy-pro:
  #   if: github.base_ref == 'main'
  #   needs: build
  #   uses: ./.github/workflows/action-deploy-pro.yml
  #   with:
  #     environment: 'pre-production'
  #     artifact-name: 'node-app-artifacts'
  #     deploy-path: './dist'
  