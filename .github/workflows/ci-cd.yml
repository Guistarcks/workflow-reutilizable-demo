name: Test-build-sonar
on:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version to use"
        required: true
        type: string
      sonar-scanner:
        description: "SonarQube scan mode"
        required: true
        type: string
        default: "off"
      deploy-entorno:
        description: "Default entorno for deployment"
        required: true
        type: string
        default: ""
      base-branches:
        description: "Base branch name for PRs"
        required: true
        type: string
        default: ""
      pr-merged:
        description: "Indicates if the PR was merged"
        required: true
        type: boolean
        default: false
      path-config-json:
        description: "Path to the config.json file"
        required: false
        type: string
        default: "./config.json"
  
jobs:

       
  read-config-json:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-vars.outputs.version }}
      sonar_scanner: ${{ steps.set-vars.outputs.sonar_scanner }}
      entorno: ${{ steps.set-vars.outputs.entorno }}
      modulo-backend: ${{ steps.set-vars.outputs.mod_backend }}
      modulo-frontend: ${{ steps.set-vars.outputs.mod_frontend  }}

    steps:
      - name: Obtener cÃ³digo fuente ðŸ“¥
        uses: actions/checkout@v4

      - name: Read configuration JSON and export variables ðŸ“„
        id: set-vars
        shell: bash
        run: |
          CONFIG_PATH="${{ inputs.path-config-json }}"
          if [ ! -f "$CONFIG_PATH" ]; then 
            echo "âŒ Config file not found: $CONFIG_PATH"
            exit 1
          fi 

          echo "ðŸ“„ Reading configuration from: $CONFIG_PATH"

          version=$(jq -r '.version' "$CONFIG_PATH")
          sonar_scanner=$(jq -r '."sonar-scanner"' "$CONFIG_PATH")
          entorno=$(jq -r '.entorno' "$CONFIG_PATH")
          # Exportar cada valor del objeto modulos como variable separada
          mod_backend=$(jq -r '.modulos.backend' "$CONFIG_PATH")
          mod_frontend=$(jq -r '.modulos.frontend' "$CONFIG_PATH")

          echo "version=$version" >> $GITHUB_OUTPUT
          echo "sonar_scanner=$sonar_scanner" >> $GITHUB_OUTPUT
          echo "entorno=$entorno" >> $GITHUB_OUTPUT
          echo "mod_backend=$mod_backend" >> $GITHUB_OUTPUT
          echo "mod_frontend=$mod_frontend" >> $GITHUB_OUTPUT

          echo "ðŸ” sonar_scanner value: $sonar_scanner"
          echo "ðŸ” entorno value: $entorno"
          echo "ðŸ” base-branches value: $base-branches"
          echo "ðŸ” pr-merged value: $pr-merged"

          echo "## ðŸ“‹ Configuration Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $version" >> $GITHUB_STEP_SUMMARY
          echo "**Sonar Scanner:** $sonar_scanner" >> $GITHUB_STEP_SUMMARY
          echo "**Entorno:** $entorno" >> $GITHUB_STEP_SUMMARY
          echo "**MÃ³dulo Backend:** $mod_backend" >> $GITHUB_STEP_SUMMARY
          echo "**MÃ³dulo Frontend:** $mod_frontend" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Configuration loaded successfully"


  print-inputs:
    needs: read-config-json
    runs-on: ubuntu-latest
    steps:
      - name: Print workflow_call inputs
        run: |
          echo "base-branches: ${{inputs.base-branches}}"
          echo "pr-merged: ${{inputs.pr-merged}}"
          echo "sonar-scanner: ${{ needs.read-config-json.outputs.sonar_scanner }}"


  test-unitarios:
    needs: [read-config-json]
    if: always() && startsWith(github.ref, 'refs/heads/feature/') || (always() && inputs.pr-merged == true && inputs.base-branches == 'develop') || (always() && inputs.pr-merged == true && inputs.base-branches == 'main')

    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: comprobar modulo
        id: check-module
        run: |
          MOD_BACKEND="${{ needs.read-config-json.outputs.modulo-backend }}"
          MOD_FRONTEND="${{ needs.read-config-json.outputs.modulo-frontend }}"

          echo "ðŸ” Debugging variables:"
          echo "MOD_BACKEND: '$MOD_BACKEND'"
          echo "MOD_FRONTEND: '$MOD_FRONTEND'"

          if [[ -n "$MOD_BACKEND" && "$MOD_BACKEND" != "null" ]]; then
            echo "âœ… Backend module found: $MOD_BACKEND"
            echo "moduleresult=$MOD_BACKEND" >> $GITHUB_OUTPUT
          elif [[ -n "$MOD_FRONTEND" && "$MOD_FRONTEND" != "null" ]]; then
            echo "âœ… Frontend module found: $MOD_FRONTEND"
            echo "moduleresult=$MOD_FRONTEND" >> $GITHUB_OUTPUT
          else
            echo "âŒ No valid module found. Backend: '$MOD_BACKEND', Frontend: '$MOD_FRONTEND'"
            exit 0
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: "npm"
          cache-dependency-path: "./${{ steps.check-module.outputs.moduleresult }}"

      - name: Install dependencies
        run: npm ci
        working-directory: "./${{ steps.check-module.outputs.moduleresult }}"

      - name: Run tests with coverage
        id: run-tests
        run: npm test -- --coverage --watchAll=false
        working-directory: "./${{ steps.check-module.outputs.moduleresult }}"
        continue-on-error: true

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: "coverage-reports"
          path: "coverage/"
          retention-days: 30
          working-directory: "./${{ steps.check-module.outputs.moduleresult }}"

      - name: Upload test results
        uses: actions/upload-artifact@v4

        with:
          name: "test-results"
          path: "coverage/lcov.info"
          retention-days: 30
          working-directory: "./${{ steps.check-module.outputs.moduleresult }}"

  sonar-scan:
    needs: [test-unitarios, read-config-json]
    if: |
        always() && startsWith(github.ref, 'refs/heads/release/') 
        || (always() && inputs.pr-merged == true && inputs.base-branches == 'develop' && needs.read-config-json.outputs.sonar_scanner !='off'
        || (always() && inputs.pr-merged == true && inputs.base-branches == 'main')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sonar Qube Scan
        run: |
          echo "SonarQube analysis would run here."
          echo "Sonar Scanner mode: ${{ needs.read-config-json.outputs.sonar_scanner }}"
          echo "Base branch: ${{ inputs.base-branches }}"
          echo "PR merged: ${{ inputs.pr-merged }}" 

  build:
    needs: [test-unitarios, read-config-json, sonar-scan]
    if: always() && inputs.pr-merged == true && inputs.base-branches == 'develop' && needs.read-config-json.outputs.sonar_scanner == 'off' 
        || always() && startsWith(github.ref, 'refs/heads/release/') 
        || always() && inputs.pr-merged == true && inputs.base-branches == 'develop' && needs.read-config-json.outputs.sonar_scanner != 'off' && success() 
        || always() && inputs.pr-merged == true && inputs.base-branches == 'main' && needs.read-config-json.outputs.sonar_scanner != 'off' && success()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build artifacts
        run: echo "AquÃ­ irÃ­a el build de los artefactos"

  deploy-develop:
    needs: build
    if: always() && inputs.pr-merged == true && inputs.base-branches == 'develop'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Development
        run: echo "AquÃ­ irÃ­a el despliegue a desarrollo"

  deploy-pre-produccion:
    needs: build
    if: always() && startsWith(github.ref, 'refs/heads/release/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Pre-Production
        run: echo "AquÃ­ irÃ­a el despliegue a pre-producciÃ³n"

  deploy-produccion:
    needs: build
    if: always() && (inputs.pr-merged == true && inputs.base-branches == 'main')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Production
        run: echo "AquÃ­ irÃ­a el despliegue a producciÃ³n"
        # ...steps para despliegue a producciÃ³n...
      # 1. Taggear versiÃ³n
      # 2. Desplegar artefacto versionado
      # 3. Ejecutar smoke tests y monitoreo post-deploy  # ...steps para despliegue a pre-producciÃ³n.

  close-release:
    needs: deploy-produccion
    name: Publish new release
    runs-on: ubuntu-latest
    if: always() && (inputs.pr-merged == true && inputs.base-branches == 'main') # only merged pull requests must trigger this job
    steps:
      - name: Extract version from branch name (for release branches)
        if: startsWith(github.event.pull_request.head.ref, 'release/')
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          VERSION=${BRANCH_NAME#release/}

          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Extract version from branch name (for hotfix branches)
        if: startsWith(github.event.pull_request.head.ref, 'hotfix/')
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          VERSION=${BRANCH_NAME#hotfix/}

          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Create Release
        uses: Guistarcks/create-release@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          target_commitish: ${{ github.event.pull_request.merge_commit_sha }}
          tag_name: ${{ env.RELEASE_VERSION }}
          name: ${{ env.RELEASE_VERSION }}
          draft: false
          prerelease: false

      - name: Merge main into develop branch
        uses: Guistarcks/create-pull-request@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          head: main
          base: develop
          title: Merge main into develop branch
          body: |
            .This PR merges the main branch back into develop.
            This happens to ensure that the updates that happend on the release branch, i.e. CHANGELOG and manifest updates are also present on the develop branch
