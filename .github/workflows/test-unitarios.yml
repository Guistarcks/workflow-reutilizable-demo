name: Test-build-sonar
on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: true
        type: string
      
jobs:
  test-unitarios:
    runs-on: ubuntu-latest
   
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        id: run-tests
        run: npm test 
        continue-on-error: false

  Test-Sonar:
    needs: test-unitarios
    runs-on: ubuntu-latest   
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configurar Java 17 para SonarQube â˜•
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
        
      - name: Ejecutar anÃ¡lisis de calidad con SonarQube ðŸ§ª
        run: |
          npm install --save-dev sonar-scanner
          npm run test -- --coverage
          npx sonar-scanner \
            -Dsonar.projectKey=${{ vars.PROJECT_KEY }} \
            -Dsonar.projectName=${{ vars.PROJECT_NAME }} \
            -Dsonar.sources=. \
            -Dsonar.exclusions=node_modules/**,dist/**,.github/** \
            -Dsonar.host.url=${{ vars.SONAR_HOST_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

  build:
      runs-on: ubuntu-latest
      needs: Test-Sonar
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
  
        - name: Set up Node.js
          uses: actions/setup-node@v4
          with:
            node-version: ${{ inputs.node-version }}
            cache: 'npm'
  
        - name: Install dependencies
          run: npm ci
  
        - name: Build project
          id: run-build
          run: npm run build || true # Placeholder; continues if no build script
          continue-on-error: true
      
        - name: Upload artifacts
          id: upload
          uses: actions/upload-artifact@v4
          with:
            name: 'node-app-artifacts'
            path: '.'
            retention-days: 7
  