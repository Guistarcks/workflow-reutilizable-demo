name: Test-build-sonar
on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: true
        type: string
      
jobs:
  test-unitarios:
    runs-on: ubuntu-latest
   
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        id: run-tests
        run: npm test -- --coverage --watchAll=false
        continue-on-error: false

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: 'coverage-reports'
          path: 'coverage/'
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: 'test-results'
          path: 'coverage/lcov.info'
          retention-days: 30

  Test-Sonar:
    needs: test-unitarios
    runs-on: ubuntu-latest   
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download coverage reports
        uses: actions/download-artifact@v4
        with:
          name: 'coverage-reports'
          path: 'coverage/'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configurar Java 17 para SonarQube â˜•
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
        
      - name: Ejecutar anÃ¡lisis de calidad con SonarQube ðŸ§ª
        run: |
          npx sonar-scanner \
            -Dsonar.projectKey=${{ vars.PROJECT_KEY }} \
            -Dsonar.projectName=${{ vars.PROJECT_NAME }} \
            -Dsonar.sources=. \
            -Dsonar.exclusions=node_modules/**,dist/**,.github/**,**/__tests__/** \
            -Dsonar.host.url=${{ vars.SONAR_HOST_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \
            -Dsonar.coverage.exclusions=**/__tests__/**,**/*.test.js

  build:
      runs-on: ubuntu-latest
      needs: Test-Sonar
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
  
        - name: Set up Node.js
          uses: actions/setup-node@v4
          with:
            node-version: ${{ inputs.node-version }}
            cache: 'npm'
  
        - name: Install dependencies
          run: npm ci
  
        - name: Build project
          id: run-build
          run: npm run build || echo "No build script found, skipping build step"
          continue-on-error: true
      
        - name: Upload artifacts
          id: upload
          uses: actions/upload-artifact@v4
          with:
            name: 'node-app-artifacts'
            path: '.'
            retention-days: 7
  