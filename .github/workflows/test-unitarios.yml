name: Test-build-sonar
on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: true
        type: string

    secrets:
      
      SONAR_TOKEN:
        description: 'Sonar token'
        required: true
        
jobs:
  test-unitarios:
    if: github.base_ref == 'develop' || startsWith(github.ref, 'refs/heads/feature/')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        id: run-tests
        run: npm test -- --coverage --watchAll=false
        continue-on-error: true
        

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
       
        with:
          name: 'coverage-reports'
          path: 'coverage/'
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
      
        with:
          name: 'test-results'
          path: 'coverage/lcov.info'
          retention-days: 30

      - name: Create test summary
     
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f "coverage/lcov.info" ]; then
            echo "✅ Tests completed with coverage report" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Tests completed without coverage report" >> $GITHUB_STEP_SUMMARY
          fi

  Test-Sonar:
    needs: test-unitarios
    uses: ./.github/workflows/action-sonar.yml
    with:
      node-version: ${{ inputs.node-version }}
      java-version: '17'
      coverage-artifact-name: 'coverage-reports'
      coverage-path: 'coverage/'
      project-key: ${{ vars.PROJECT_KEY }}
      project-name: ${{ vars.PROJECT_NAME }}
      sonar-host-url: ${{ vars.SONAR_HOST_URL }}
      sources-path: '.'
      exclusions: '**/*.java'
      coverage-exclusions: '**/*.test.js,**/*.spec.js,**/node_modules/**'
      lcov-report-path: 'coverage/lcov.info'
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
       
  build:
    if: github.base_ref == 'develop'
    needs: Test-Sonar
    uses: ./.github/workflows/action-build.yml
    with:
      node-version: ${{ inputs.node-version }}
      build-command: 'npm run build'
      artifact-name: 'node-app-artifacts'
      artifact-path: '.'
      retention-days: 7

  deploy-pre:
    if: github.base_ref == 'develop'
    needs: build
    uses: ./.github/workflows/action-deploy-pre.yml
    with:
      environment: 'pre-production'
      artifact-name: 'node-app-artifacts'
      deploy-path: './dist'

  deploy-pro:
    if: github.base_ref == 'develop'
    needs: build
    uses: ./.github/workflows/action-deploy-pro.yml
    with:
      environment: 'pre-production'
      artifact-name: 'node-app-artifacts'
      deploy-path: './dist'
  